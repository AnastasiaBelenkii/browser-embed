<div class="search-container">
  <input
    type="text"
    id="search-input"
    placeholder="Loading model..."
    aria-label="Semantic search query"
    disabled
  />
  <button id="search-button" disabled>Search</button>
  <div id="spinner" class="spinner"></div>
</div>

<script type="module">
import { Tensor } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.5.0/dist/transformers.min.js';

// --- State and Data ---
let pipeline = null;

const CORPUS = [
    "The cat sat on the mat.",
    "My dog loves to chase squirrels.",
    "The sun is a star.",
    "Jupiter is the largest planet in our solar system.",
    "I enjoy reading books about history.",
    "She is a talented musician who plays the piano.",
    "The new software update includes several security patches.",
    "To build a web application, you need to know HTML, CSS, and JavaScript.",
    "The stock market experienced a significant downturn.",
    "Economic policy can have a major impact on inflation."
];
let corpusEmbeddings = null;


// --- UI Management ---

function getDOMElements() {
    const button = document.getElementById('search-button');
    const input = document.getElementById('search-input');
    const spinner = document.getElementById('spinner');
    const corpusDiv = document.getElementById('corpus-container');
    const queryDiv = document.getElementById('query-container');
    if (!button || !input || !spinner || !corpusDiv || !queryDiv) {
        throw new Error("Component UI elements not found.");
    }
    return { button, input, spinner, corpusDiv, queryDiv };
}

function setUIState(state) {
    const { button, input, spinner } = getDOMElements();
    
    const states = {
        loadingModel: () => {
            input.disabled = true;
            button.disabled = true;
            input.placeholder = 'Loading model...';
            spinner.classList.remove('hidden');
        },
        indexing: () => {
            input.disabled = true;
            button.disabled = true;
            input.placeholder = 'Creating search index...';
            spinner.classList.remove('hidden');
        },
        ready: () => {
            input.disabled = false;
            button.disabled = false;
            input.placeholder = 'Enter search query...';
            spinner.classList.add('hidden');
        },
        searching: () => {
            input.disabled = true;
            button.disabled = true;
            button.textContent = 'Searching...';
            spinner.classList.remove('hidden');
        },
        error: () => {
            input.disabled = true;
            button.disabled = true;
            input.placeholder = 'An error occurred.';
            button.textContent = 'Error';
            spinner.classList.add('hidden');
        }
    };

    if (states[state]) {
        states[state]();
    }
}

function renderCorpus() {
    const { corpusDiv } = getDOMElements();
    corpusDiv.innerHTML = '<h2>Corpus</h2>';
    
    CORPUS.forEach((text, i) => {
        const vector = corpusEmbeddings.data.slice(i * 384, (i + 1) * 384);
        corpusDiv.innerHTML += `
            <div class="corpus-item" id="corpus-item-${i}">
                <div class="corpus-text">${text}</div>
                <div class="corpus-vector-preview">
                    [${vector.slice(0, 4).map(v => v.toFixed(2)).join(', ')}, ...]
                    <button class="toggle-vector-btn" data-target="corpus-vector-full-${i}">Show Vector</button>
                </div>
                <div class="corpus-vector-full hidden" id="corpus-vector-full-${i}">
                    [${vector.join(', ')}]
                </div>
                <div class="similarity-score" id="similarity-score-${i}"></div>
            </div>
        `;
    });
}

function renderQueryEmbedding(query, embedding) {
    const { queryDiv } = getDOMElements();
    const vector = embedding.data;
    queryDiv.innerHTML = `
        <h2>Your Query</h2>
        <div class="query-item">
            <div class="query-text">"${query}"</div>
            <div class="corpus-vector-preview">
                [${vector.slice(0, 4).map(v => v.toFixed(2)).join(', ')}, ...]
                <button class="toggle-vector-btn" data-target="query-vector-full">Show Vector</button>
            </div>
            <div class="corpus-vector-full hidden" id="query-vector-full">
                [${vector.join(', ')}]
            </div>
        </div>
    `;
}

function highlightTopResult(searchResults) {
    // Clear previous highlights and scores
    document.querySelectorAll('.corpus-item').forEach(item => {
        item.classList.remove('highlight');
    });
    document.querySelectorAll('.similarity-score').forEach(score => {
        score.textContent = '';
    });

    if (searchResults.length > 0) {
        const topResult = searchResults[0];
        const topItem = document.getElementById(`corpus-item-${topResult.index}`);
        const topScore = document.getElementById(`similarity-score-${topResult.index}`);

        if (topItem && topScore) {
            topItem.classList.add('highlight');
            topScore.textContent = `Similarity: ${topResult.score.toFixed(4)}`;
        }
    }
}

// --- Core Logic ---

function cosineSimilarity(vecA, vecB) {
    let dotProduct = 0;
    let normA = 0;
    let normB = 0;
    for (let i = 0; i < vecA.length; i++) {
        dotProduct += vecA[i] * vecB[i];
        normA += vecA[i] * vecA[i];
        normB += vecB[i] * vecB[i];
    }
    return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
}

async function handleSearch() {
  console.log('Search button clicked');
  const { input, queryDiv } = getDOMElements();

  try {
    if (!pipeline) {
      throw new Error('Pipeline not available.');
    }

    const query = input.value.trim();
    if (!query) {
      queryDiv.innerHTML = ''; // Clear previous query if search is empty
      return;
    }

    setUIState('searching');

    // Generate embedding for the user's query
    const queryEmbedding = await pipeline(query, { pooling: 'mean', normalize: true });
    renderQueryEmbedding(query, queryEmbedding);

    // Perform the search
    const searchResults = [];
    for (let i = 0; i < CORPUS.length; i++) {
        // Extract the pre-computed embedding for the current corpus item
        const docEmbeddingData = corpusEmbeddings.data.slice(i * 384, (i + 1) * 384);
        const score = cosineSimilarity(queryEmbedding.data, docEmbeddingData);
        searchResults.push({ text: CORPUS[i], score: score, index: i });
    }

    // Sort results by score
    searchResults.sort((a, b) => b.score - a.score);

    // Highlight the top result in the UI
    highlightTopResult(searchResults);
    
  } catch (error) {
    console.error('Search failed:', error);
    alert(`Search failed: ${error.message}`);
  } finally {
    setUIState('ready');
    const { button } = getDOMElements();
    button.textContent = 'Search';
  }
}

async function setupSearchComponent() {
    const { button, input, corpusDiv } = getDOMElements();

    document.addEventListener('model-ready', async (event) => {
        console.log('Model is ready.');
        pipeline = event.detail.pipeline;

        // Pre-compute embeddings for the corpus
        setUIState('indexing');
        corpusEmbeddings = await pipeline(CORPUS, { pooling: 'mean', normalize: true });
        console.log('Corpus indexed.');
        
        renderCorpus();
        setUIState('ready');
    });

    document.addEventListener('model-error', (event) => {
        console.error('Model loading failed, updating UI.', event.detail);
        setUIState('error');
    });

    button.addEventListener('click', (e) => {
        e.preventDefault();
        handleSearch().catch(console.error);
    });

    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            button.click();
        }
    });

    // Event delegation for toggle buttons
    document.body.addEventListener('click', (e) => {
        if (e.target.classList.contains('toggle-vector-btn')) {
            const targetId = e.target.getAttribute('data-target');
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                targetElement.classList.toggle('hidden');
                e.target.textContent = targetElement.classList.contains('hidden') ? 'Show Vector' : 'Hide Vector';
            }
        }
    });
}

try {
    setupSearchComponent();
} catch (error) {
    console.error('Failed to initialize search component:', error);
    const container = document.querySelector('.search-container');
    if (container) {
        container.innerHTML = `<div class="error" style="width: 100%; text-align: center;">Error: Search component failed to load.</div>`;
    }
}
</script>

<style>
.search-container {
  margin: 2rem 0;
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

#search-input {
  flex-grow: 1;
  padding: 0.5rem;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 1rem;
}

#search-button {
  padding: 0.5rem 1rem;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 1rem;
  /* Ensure button height is consistent */
  height: 42px;
}

#search-button:hover:not(:disabled) {
  background: #0069d9;
}

#search-button:disabled {
    cursor: not-allowed;
    opacity: 0.7;
}
</style>
